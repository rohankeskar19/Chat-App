<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
       
        <form id="form">
                <input id="inputField" type="text"/>
                <button type="submit">Submit</button>
            </form>

            <div id="messages">

                </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
    <script>
        var token = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjp7ImlkIjoiNWNjY2ExMjFjMmZmNWYxMTcwOTY4NjVhIiwibmFtZSI6Ik5laGEgUnVud2FsIiwidXNlcm5hbWUiOiJuZWhhLnJ1bndhbCIsImVtYWlsIjoicm9oYW5rZXNrYXIxMEBnbWFpbC5jb20iLCJwcm9maWxlVXJsIjoiLy93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci9iYjlmNWZkNTEwYzc0N2MyZWQ4ZTFjZTBkYjBjZTZkZT9zPTIwMCZyPXBnJmQ9bW0ifSwiaWF0IjoxNTU2OTk3NTkyLCJleHAiOjE1NTgwNzc1OTJ9._IFbNNrd3LLbLSHJLNXoKr-P-_qQjUv_iRXSehUhbOM";
        var socket = io.connect('http://localhost:4000', {
                        query: {token: token}
                    });
                    
                    var decoded = parseJwt(token);

                    var user = decoded.user;
                    console.log(user);
                    
                    // socket.emit('createConversation',{
                    //     users : [user.id,"5ccca0edc2ff5f1170968657"]
                    // })

                    // socket.emit('createMessage',{
                    //     conversationID : "",
                    //     fromId : "",
                    //     toId : "",
                    //     content : ""
                    // })

                    // socket.on("online",(data) => {

                    // })

                    
                    function parseJwt (token) {
                        var base64Url = token.split('.')[1];
                        var base64 = decodeURIComponent(atob(base64Url).split('').map(function(c) {
                            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                        }).join(''));

                        return JSON.parse(base64);
                    };


                    var input = document.getElementById("inputField");
                    input.addEventListener("change",function(e){
                        socket.emit("typing",user);
                    });

                    document.getElementById("form").addEventListener("submit",function(e){
                        e.preventDefault();
                        
                        socket.emit("createMessage",{
                            conversationID : "5ccdcf935218b20998872876",
                            fromId : user.id,
                            toId : "5ccca0ffc2ff5f1170968658",
                            content : input.value,
                        });
                        input.value = "";
                    })

                    socket.on("typing",(data) => {
                        console.log(data.username + " is typing");
                    });

                    socket.on("online",(data) => {
                        console.log(data.username + " is online");
                    });

                    socket.on("offline",(data) => {
                        console.log(data.username + " is offline");
                    })

                    socket.on("newMessage",(data) => {
                        // console.log("new Message");

                        document.getElementById("messages").innerHTML += `<p>${data.fromId}</p><p>${data.content}</p>`;
                    })

    </script>
</body>
</html>